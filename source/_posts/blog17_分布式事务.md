---
title: 分布式事务
---

#### 什么是分布式事务
* 在分布式系统中，一次操作由多个系统通过网络协调完成(如创建订单就涉及到订单系统和库存管理系统的协同操作)，或是一个应用使用了不同的数据源连接了不同的数据库，一次事务需要同时操作多个数据库。这两种都是分布式事务的体现。

#### 如何处理分布式事务
##### 理论基础
* CPA理论
	* 分布式系统只能在设计时同时满足Consistency(一致性)、Availability可用性、PartitionTolerance分区容忍性中的其中两个。三者无法全部兼顾。
	* Consistency一致性：所有存储节点中的数据要时刻保持同步
	* Availability可用性：集群总某一节点的宕机不影响整个集群对外提供服务
	* Partition Tolerance分区容忍性：允许系统中的节点通过网络协同工作
* 具体组合方式
	* CA放弃分区容忍性，关系型数据库使用
	* PA放弃强一致性，只保证最终一致性，非关系型数据库使用，分布式系统常用
	* CP放弃分区容忍性：允许系统中的节点通过网络协同工作
##### 实现方式
* 2PC(2 Phase Commitmengt Protocol)两阶段提交协议
	* 引入一个事务协调齐全
	* 事务协调器向两个数据库分别发送prepare信息，如：A+1000,B-1000
	* AB两个数据库收到消息后执行相应的操作，但不提交。执行成功后，向事务协调器返回yes，否则返回no
	* 所有的数据库都返回yes后，事务协调器再通知所有数据库统一提交
	* 只要有一个数控返回no，事务协调器就通知所有数据库回滚
	* 回滚是基于日志的，事务协调器和数据库进行的所有操作都记录在日志上，失败后按日志记录回滚

* TCC(Try Confirm Cancel)事务补偿
	* Try尝试
		* 应用程序分别向两个数据库发送Try请求，如：A+1000,B -1000
		* A检查数据能否添加(是不是只能读不能写)，返回信息告知应用程序
		* B检测数据能否减少(余额是否充足)，锁定资源(冻结要转账的资金)，返回信息告知应用程序
	* Confirm确认
		* AB都确认可以进行操作后，执行对应的操作
	* Cancel取消
		* AB有任何一方不满足操作条件，取消操作，释放被锁定的资源

* 2PC与TCC
	* 2PC需要引入事务协调器，应用程序和协调器对接，由事务协调器调度事务。过程是操作前记录日志，操作成功就提交，操作失败则根据日志回滚。(先提交，再根据结果进行后续操作)
	* TCC没有事务协调器，应用程序直接与数据库对金额。操作前锁定数据，检查是否能执行操作，确认可执行就进行操作，不可执行则放弃操作并释放资源。（先检查，再根据检查结果进行后续操作）

* 通过MQ实现分布式事务
	* A+1000，记录日志，发送消息到MQ:"A已添加1000，B需要对应减1000"
	* MQ将A的消息转发给B
	* B接收消息，检查日志之前有没有进行过减1000的操作，确认之前没有执行过则按照消息要求减1000。向MQ发送消息"B减1000完毕"
	* MQ将消息转发给A
	* A收到消息后，将日志中要求B减1000的记录删除

#### 参考
##### [两阶段提交2PC](https://blog.csdn.net/bjweimengshu/article/details/79607522 )
##### [MQ处理](https://blog.csdn.net/baidu_38116275/article/details/78688822)
